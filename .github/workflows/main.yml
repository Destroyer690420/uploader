name: ðŸ¤– Auto-Post Pipeline

on:
  schedule:
    - cron: '0 */3 * * *'       # Every 2 hours
  workflow_dispatch:             # Manual trigger for testing

permissions:
  contents: write                # Needed to push processed_ids.txt & README.md

jobs:
  post-video:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout repo (with token so we can push back) â”€â”€
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Set up Python â”€â”€
      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€ Install dependencies â”€â”€
      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      # â”€â”€ Install ffmpeg (needed for video conversion) â”€â”€
      - name: ðŸŽ¬ Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      # â”€â”€ Recreate cookie files from secrets â”€â”€
      - name: ðŸª Write cookies.json (X/Twitter)
        run: |
          mkdir -p public
          echo '${{ secrets.COOKIES_JSON }}' > public/cookies.json

      - name: ðŸª Write ig_cookies.json (Instagram)
        run: |
          echo '${{ secrets.IG_COOKIES_JSON }}' > public/ig_cookies.json

      # â”€â”€ Run the pipeline â”€â”€
      - name: Run script
        env:
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
        run: python main.py

      # â”€â”€ Commit & push state + dashboard â”€â”€
      - name: ðŸ“¤ Push state & dashboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f processed_ids.txt yt_daily_count.txt README.md
          git diff --staged --quiet || git commit -m "ðŸ¤– Bot: Dashboard & Queue Updated"
          git pull --rebase origin main
          git push
