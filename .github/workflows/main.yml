name: ðŸ¤– Auto-Post Pipeline

on:
  schedule:
    - cron: '0 */2 * * *'   # Every 2 hours
  workflow_dispatch:          # Manual trigger for testing

permissions:
  contents: write             # Needed to push processed_ids.txt & README.md

jobs:
  post-video:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout repo (with token so we can push back) â”€â”€
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Set up Python â”€â”€
      - name: ðŸ Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€ Install dependencies â”€â”€
      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      # â”€â”€ Recreate cookies.json from secret â”€â”€
      - name: ðŸª Write cookies.json
        run: |
          mkdir -p public
          echo '${{ secrets.COOKIES_JSON }}' > public/cookies.json

      # â”€â”€ Run the pipeline â”€â”€
      - name: ðŸš€ Run pipeline
        env:
          # YouTube Data API v3
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          # Instagram Graph API
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
        run: python main.py

      # â”€â”€ Commit & push state + dashboard â”€â”€
      - name: ðŸ“¤ Push state & dashboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f processed_ids.txt yt_daily_count.txt README.md
          git diff --staged --quiet || git commit -m "ðŸ¤– Bot: Dashboard & Queue Updated"
          git push
